<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PDF & URL Threat Checker | VirusTotal Powered</title>
  <meta name="description" content="Check PDFs and URLs for embedded malware using VirusTotal API and heuristic analysis.">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0c101a;
      --panel: #12192b;
      --panel-strong: #172137;
      --text: #e9edf5;
      --muted: #9ca8bd;
      --border: rgba(255, 255, 255, 0.08);
      --accent: #22d3ee;
      --accent-strong: #0ea5e9;
      --success: #34d399;
      --warning: #fbbf24;
      --danger: #f472b6;
      --vt-blue: #394eff;
      --shadow: 0 10px 50px rgba(0, 0, 0, 0.45);
      --radius: 16px;
      --blur: 90px;
    }

    body[data-theme="light"] {
      --bg: #f7f8fb;
      --panel: #ffffff;
      --panel-strong: #edf1f8;
      --text: #0f172a;
      --muted: #4b5563;
      --border: rgba(15, 23, 42, 0.08);
      --accent: #0ea5e9;
      --accent-strong: #0284c7;
      --success: #16a34a;
      --warning: #d97706;
      --danger: #dc2626;
      --vt-blue: #394eff;
      --shadow: 0 20px 40px rgba(15, 23, 42, 0.1);
      --blur: 70px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: "Space Grotesk", "Segoe UI", "Helvetica Neue", Arial, sans-serif;
      background: radial-gradient(circle at 20% 20%, rgba(34, 211, 238, 0.07), transparent 35%),
                  radial-gradient(circle at 80% 0%, rgba(14, 165, 233, 0.08), transparent 30%),
                  var(--bg);
      color: var(--text);
      transition: background 0.4s ease, color 0.4s ease;
      padding: 32px clamp(16px, 5vw, 64px);
    }

    .glass {
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.04), rgba(255, 255, 255, 0.02));
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
      border-radius: var(--radius);
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 32px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 600;
      letter-spacing: 0.4px;
    }

    .brand .logo {
      width: 42px;
      height: 42px;
      border-radius: 14px;
      background: linear-gradient(135deg, var(--accent-strong), var(--accent));
      display: grid;
      place-items: center;
      color: #0b1220;
      font-weight: 700;
      box-shadow: 0 10px 25px rgba(34, 211, 238, 0.3);
    }

    .top-actions {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    button {
      font: inherit;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .mode-toggle {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      border-radius: 999px;
      background: var(--panel);
      color: var(--text);
      border: 1px solid var(--border);
    }

    .mode-toggle:hover {
      transform: translateY(-1px);
      border-color: rgba(255, 255, 255, 0.12);
    }

    main {
      max-width: 1100px;
      margin: 0 auto;
      display: grid;
      gap: 20px;
    }

    .hero {
      display: grid;
      gap: 10px;
    }

    .eyebrow {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      color: var(--accent);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1.2px;
      font-size: 12px;
    }

    h1 {
      margin: 0;
      font-size: clamp(28px, 4vw, 40px);
      letter-spacing: -0.5px;
    }

    .subhead {
      margin: 0;
      color: var(--muted);
      font-size: 16px;
      max-width: 720px;
      line-height: 1.6;
    }

    /* Tab Navigation */
    .tab-nav {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
    }

    .tab-btn {
      padding: 12px 20px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--panel);
      color: var(--muted);
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .tab-btn.active {
      background: linear-gradient(135deg, var(--accent), var(--accent-strong));
      color: #0b1220;
      border-color: transparent;
      box-shadow: 0 8px 24px rgba(14, 165, 233, 0.25);
    }

    .tab-btn:hover:not(.active) {
      border-color: rgba(255, 255, 255, 0.14);
      transform: translateY(-1px);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .panel-grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 18px;
    }

    @media (max-width: 900px) {
      .panel-grid {
        grid-template-columns: 1fr;
      }
      body {
        padding: 24px clamp(12px, 4vw, 32px);
      }
    }

    .drop-panel {
      position: relative;
      padding: clamp(22px, 3vw, 28px);
      overflow: hidden;
    }

    .drop-panel::before {
      content: "";
      position: absolute;
      inset: -20% -10%;
      background: radial-gradient(circle at 20% 30%, rgba(34, 211, 238, 0.12), transparent 35%),
                  radial-gradient(circle at 80% 30%, rgba(14, 165, 233, 0.1), transparent 32%);
      filter: blur(var(--blur));
      z-index: 0;
    }

    .drop-panel > * {
      position: relative;
      z-index: 1;
    }

    .dropzone {
      display: block;
      border: 1.5px dashed var(--border);
      background: linear-gradient(145deg, rgba(255, 255, 255, 0.03), rgba(255, 255, 255, 0.015));
      border-radius: var(--radius);
      padding: clamp(32px, 4vw, 40px);
      text-align: center;
      transition: border-color 0.2s ease, transform 0.15s ease, box-shadow 0.2s ease;
      cursor: pointer;
      position: relative;
    }

    .dropzone.dragover {
      border-color: var(--accent);
      box-shadow: 0 25px 50px rgba(34, 211, 238, 0.15);
      transform: translateY(-2px);
    }

    .drop-icon {
      width: 56px;
      height: 56px;
      margin: 0 auto 12px;
      border-radius: 16px;
      display: grid;
      place-items: center;
      background: rgba(34, 211, 238, 0.09);
      color: var(--accent);
    }

    .drop-title {
      font-size: 18px;
      margin: 0 0 6px;
      font-weight: 600;
    }

    .muted {
      color: var(--muted);
      margin: 0 0 14px;
      line-height: 1.5;
    }

    .actions {
      display: flex;
      justify-content: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .primary {
      padding: 12px 18px;
      border-radius: 999px;
      background: linear-gradient(135deg, var(--accent), var(--accent-strong));
      color: #0b1220;
      font-weight: 700;
      box-shadow: 0 12px 30px rgba(14, 165, 233, 0.25);
    }

    .primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 36px rgba(14, 165, 233, 0.3);
    }

    .primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .ghost {
      padding: 12px 16px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--panel);
      color: var(--text);
    }

    .ghost:hover {
      border-color: rgba(255, 255, 255, 0.14);
      transform: translateY(-1px);
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.04);
      color: var(--muted);
      border: 1px solid var(--border);
      font-size: 13px;
    }

    .pill .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--accent);
      box-shadow: 0 0 0 6px rgba(34, 211, 238, 0.12);
    }

    .pill.vt {
      background: rgba(57, 78, 255, 0.1);
      border-color: rgba(57, 78, 255, 0.3);
      color: var(--vt-blue);
    }

    .checks {
      display: grid;
      gap: 8px;
      margin-top: 16px;
      color: var(--muted);
      font-size: 14px;
    }

    .checks strong {
      color: var(--text);
    }

    /* URL Input Section */
    .url-input-section {
      padding: clamp(22px, 3vw, 28px);
    }

    .url-input-wrapper {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
    }

    .url-input {
      flex: 1;
      padding: 14px 18px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--panel-strong);
      color: var(--text);
      font: inherit;
      font-size: 15px;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .url-input::placeholder {
      color: var(--muted);
    }

    .url-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 4px rgba(34, 211, 238, 0.15);
    }

    .side-panel {
      padding: 18px;
      display: grid;
      gap: 14px;
    }

    .mini-title {
      margin: 0 0 6px;
      font-size: 15px;
      font-weight: 600;
    }

    .badge-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .badge {
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--panel-strong);
      color: var(--text);
      font-size: 13px;
    }

    .legend {
      display: grid;
      gap: 10px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--panel);
      color: var(--muted);
      font-size: 14px;
    }

    .legend-item strong {
      color: var(--text);
    }

    .legend-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }

    .results {
      display: grid;
      gap: 12px;
    }

    .result-card {
      display: grid;
      gap: 8px;
      padding: 16px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: var(--panel);
      transition: transform 0.15s ease, border-color 0.15s ease;
    }

    .result-card:hover {
      transform: translateY(-1px);
      border-color: rgba(34, 211, 238, 0.2);
    }

    .result-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }

    .file-name {
      font-weight: 600;
      word-break: break-all;
    }

    .status {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 13px;
      border: 1px solid var(--border);
    }

    .status.clean {
      color: var(--success);
      border-color: rgba(52, 211, 153, 0.25);
    }

    .status.caution {
      color: var(--warning);
      border-color: rgba(251, 191, 36, 0.25);
    }

    .status.warning {
      color: var(--danger);
      border-color: rgba(244, 114, 182, 0.35);
    }

    /* VT Stats Display */
    .vt-stats {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      padding: 12px;
      border-radius: 12px;
      background: rgba(57, 78, 255, 0.05);
      border: 1px solid rgba(57, 78, 255, 0.15);
    }

    .vt-stat {
      display: flex;
      flex-direction: column;
      gap: 2px;
      font-size: 13px;
    }

    .vt-stat-value {
      font-size: 20px;
      font-weight: 700;
    }

    .vt-stat-value.danger {
      color: var(--danger);
    }

    .vt-stat-value.warning {
      color: var(--warning);
    }

    .vt-stat-value.success {
      color: var(--success);
    }

    .vt-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      background: rgba(57, 78, 255, 0.12);
      color: var(--vt-blue);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .finding-list {
      display: grid;
      gap: 6px;
      margin: 0;
      padding-left: 18px;
      color: var(--muted);
      font-size: 14px;
    }

    .meta {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      color: var(--muted);
      font-size: 13px;
    }

    .meta .pill {
      background: rgba(255, 255, 255, 0.02);
      border-radius: 10px;
      padding: 8px 10px;
    }

    .helper {
      font-size: 14px;
      color: var(--muted);
      margin: 6px 0 0;
    }

    .footer-note {
      text-align: center;
      color: var(--muted);
      font-size: 13px;
      margin-top: 10px;
    }

    .file-input {
      position: absolute;
      opacity: 0;
      width: 1px;
      height: 1px;
      top: 0;
      left: 0;
    }

    .scan-type-toggle {
      display: flex;
      gap: 12px;
      margin-top: 12px;
    }

    .scan-type-btn {
      padding: 8px 14px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--panel);
      color: var(--muted);
      font-size: 13px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .scan-type-btn.active {
      background: var(--accent);
      color: #0b1220;
      border-color: transparent;
    }

    .scan-type-btn:hover:not(.active) {
      border-color: rgba(255, 255, 255, 0.14);
    }

    /* Loading spinner */
    .spinner {
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: currentColor;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .vt-link {
      color: var(--vt-blue);
      text-decoration: none;
      font-size: 13px;
    }

    .vt-link:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body data-theme="dark">
  <header>
    <div class="brand">
      <div class="logo">TC</div>
      <div>
        <div>Threat Checker</div>
        <small style="color: var(--muted);">PDF & URL scanning ‚Äî VirusTotal powered</small>
      </div>
    </div>
    <div class="top-actions">
      <span class="vt-badge" id="vtStatus">‚è≥ Checking VT...</span>
      <button class="mode-toggle" id="modeToggle" aria-label="Toggle color mode">
        <span id="modeIcon">üåô</span>
        <span id="modeLabel">Dark</span>
      </button>
    </div>
  </header>

  <main>
    <section class="hero">
      <div class="eyebrow">
        <span class="pill"><span class="dot"></span>Threat Intelligence</span>
        <span>VirusTotal + Heuristics</span>
      </div>
      <h1>Check PDFs & URLs for malware signals before you open them.</h1>
      <p class="subhead">Scan PDFs with heuristic analysis and VirusTotal's threat intelligence. Check URLs against 70+ security vendors. All scans are performed securely via API.</p>
    </section>

    <!-- Tab Navigation -->
    <div class="tab-nav">
      <button class="tab-btn active" data-tab="pdf">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="4" y="3" width="16" height="18" rx="2"></rect>
          <path d="M8 7h8M8 11h8M8 15h5"></path>
        </svg>
        PDF Scan
      </button>
      <button class="tab-btn" data-tab="url">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"></path>
          <path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"></path>
        </svg>
        URL Scan
      </button>
    </div>

    <!-- PDF Scan Tab -->
    <section class="tab-content active" id="tab-pdf">
      <section class="panel-grid">
        <div class="drop-panel glass">
          <div class="dropzone" id="dropzone">
            <div class="drop-icon">
              <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                <rect x="4" y="3" width="16" height="18" rx="2"></rect>
                <path d="M8 7h8M8 11h8M8 15h5"></path>
              </svg>
            </div>
            <h3 class="drop-title">Drag & drop your PDF</h3>
            <p class="muted">Scans run through heuristic analysis + optional VirusTotal threat intelligence.</p>
            <div class="actions">
              <label class="primary" id="browseBtn" for="fileInput" role="button" tabindex="0">Choose PDF</label>
              <button class="ghost" type="button" id="demoBtn">Try a demo scan</button>
            </div>
            <p class="helper">Supports multiple files. Password-protected files may limit checks.</p>
            <input type="file" id="fileInput" accept="application/pdf" multiple class="file-input" aria-label="Choose PDF">
            <div class="scan-type-toggle">
              <button class="scan-type-btn active" data-type="quick">‚ö° Quick (Heuristics Only)</button>
              <button class="scan-type-btn" data-type="full">üõ°Ô∏è Full (+ VirusTotal)</button>
            </div>
          </div>
          <div class="checks">
            <div><strong>What we flag:</strong> embedded JavaScript, auto-open actions (AA/OpenAction), Launch commands, embedded files/media, external URIs.</div>
            <div><strong>Full scan:</strong> Adds VirusTotal's 70+ security vendor analysis for comprehensive threat detection.</div>
          </div>
        </div>

        <aside class="side-panel glass">
          <div>
            <p class="mini-title">Scan Legend</p>
            <div class="legend">
              <div class="legend-item">
                <span class="legend-dot" style="background: var(--success);"></span>
                <span><strong>Clean</strong> ‚Äî no risky patterns detected.</span>
              </div>
              <div class="legend-item">
                <span class="legend-dot" style="background: var(--warning);"></span>
                <span><strong>Caution</strong> ‚Äî medium-risk features found.</span>
              </div>
              <div class="legend-item">
                <span class="legend-dot" style="background: var(--danger);"></span>
                <span><strong>Warning</strong> ‚Äî high-risk triggers detected.</span>
              </div>
            </div>
          </div>
          <div>
            <p class="mini-title">Quick tips</p>
            <div class="badge-row">
              <span class="badge">Open only if you trust the sender</span>
              <span class="badge">Disable PDF auto-open in browsers</span>
              <span class="badge">Keep your viewer updated</span>
            </div>
          </div>
        </aside>
      </section>
    </section>

    <!-- URL Scan Tab -->
    <section class="tab-content" id="tab-url">
      <section class="panel-grid">
        <div class="url-input-section glass">
          <div class="drop-icon" style="margin-bottom: 16px;">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
              <path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"></path>
              <path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"></path>
            </svg>
          </div>
          <h3 class="drop-title">Check URL reputation</h3>
          <p class="muted">Scan any URL against VirusTotal's 70+ security vendors to detect phishing, malware, and other threats.</p>
          
          <div class="url-input-wrapper">
            <input type="url" class="url-input" id="urlInput" placeholder="https://example.com" autocomplete="url">
            <button class="primary" id="urlScanBtn">Scan URL</button>
          </div>
          
          <div class="checks">
            <div><strong>What we detect:</strong> phishing sites, malware distribution, C&C servers, suspicious redirects, malicious scripts.</div>
            <div><strong>Powered by:</strong> VirusTotal's database of 70+ security vendors including Google Safe Browsing, Fortinet, Kaspersky, and more.</div>
          </div>
        </div>

        <aside class="side-panel glass">
          <div>
            <p class="mini-title">URL Safety Tips</p>
            <div class="legend">
              <div class="legend-item">
                <span class="legend-dot" style="background: var(--success);"></span>
                <span><strong>Safe</strong> ‚Äî no vendors flagged this URL.</span>
              </div>
              <div class="legend-item">
                <span class="legend-dot" style="background: var(--warning);"></span>
                <span><strong>Suspicious</strong> ‚Äî some vendors raised concerns.</span>
              </div>
              <div class="legend-item">
                <span class="legend-dot" style="background: var(--danger);"></span>
                <span><strong>Malicious</strong> ‚Äî vendors detected threats.</span>
              </div>
            </div>
          </div>
          <div>
            <p class="mini-title">Before clicking links</p>
            <div class="badge-row">
              <span class="badge">Hover to preview URLs</span>
              <span class="badge">Check for typosquatting</span>
              <span class="badge">Verify HTTPS</span>
            </div>
          </div>
        </aside>
      </section>
    </section>

    <section>
      <p class="mini-title">Scan results</p>
      <div class="results" id="results">
        <div class="result-card">
          <div class="result-header">
            <span class="file-name">No scans yet</span>
            <span class="status caution">Idle</span>
          </div>
          <p class="muted">Drop a PDF or enter a URL above to see threat analysis results.</p>
        </div>
      </div>
      <p class="footer-note">For critical documents or URLs, verify with multiple sources. VirusTotal rate limits: 4 requests/minute on free tier.</p>
    </section>
  </main>

  <script>
    const dropzone = document.getElementById('dropzone');
    const fileInput = document.getElementById('fileInput');
    const demoBtn = document.getElementById('demoBtn');
    const results = document.getElementById('results');
    const modeToggle = document.getElementById('modeToggle');
    const modeIcon = document.getElementById('modeIcon');
    const modeLabel = document.getElementById('modeLabel');
    const urlInput = document.getElementById('urlInput');
    const urlScanBtn = document.getElementById('urlScanBtn');
    const vtStatus = document.getElementById('vtStatus');
    const tabBtns = document.querySelectorAll('.tab-btn');
    const scanTypeBtns = document.querySelectorAll('.scan-type-btn');

    let scanType = 'quick'; // 'quick' or 'full'
    let vtConfigured = false;

    const heuristics = [
      { key: 'javascript', pattern: /\/JavaScript|\/JS/i, message: 'Embedded JavaScript found', severity: 'high' },
      { key: 'launch', pattern: /\/Launch/i, message: 'Launch action detected', severity: 'high' },
      { key: 'openAction', pattern: /\/OpenAction|\/AA\b/i, message: 'Auto-run action on open', severity: 'medium' },
      { key: 'embeddedFile', pattern: /\/EmbeddedFile|\/Filespec/i, message: 'Embedded file present', severity: 'medium' },
      { key: 'richMedia', pattern: /\/RichMedia|\/MediaClip/i, message: 'Rich media stream detected', severity: 'medium' },
      { key: 'uri', pattern: /\/URI|http:\/\/|https:\/\//i, message: 'External links present', severity: 'info' }
    ];

    function computeApiBase() {
      const { origin, protocol, hostname } = window.location;
      if (protocol === 'file:') return 'http://127.0.0.1:8081';
      if (hostname === 'localhost' || hostname === '127.0.0.1') return origin.replace(/\/$/, '');
      return '';
    }

    const apiBase = computeApiBase();
    const apiEndpoint = `${apiBase}/api/scan`;
    const apiVtEndpoint = `${apiBase}/api/scan-vt`;
    const apiUrlScanEndpoint = `${apiBase}/api/url-scan`;
    const healthEndpoint = `${apiBase}/api/health`;
    let apiAvailable = true;

    function setTheme(mode) {
      document.body.setAttribute('data-theme', mode);
      const dark = mode === 'dark';
      modeIcon.textContent = dark ? 'üåô' : '‚òÄÔ∏è';
      modeLabel.textContent = dark ? 'Dark' : 'Light';
      try {
        localStorage.setItem('pdf-theme', mode);
      } catch (e) {}
    }

    function initTheme() {
      let saved = null;
      try {
        saved = localStorage.getItem('pdf-theme');
      } catch (e) {}
      if (saved === 'light' || saved === 'dark') {
        setTheme(saved);
        return;
      }
      const prefersLight = window.matchMedia('(prefers-color-scheme: light)').matches;
      setTheme(prefersLight ? 'light' : 'dark');
    }

    function humanSize(bytes) {
      if (bytes === 0) return '0 B';
      const units = ['B', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(1024));
      return (bytes / Math.pow(1024, i)).toFixed(1) + ' ' + units[i];
    }

    function renderVtStats(stats) {
      if (!stats) return '';
      return `
        <div class="vt-stats">
          <div class="vt-stat">
            <span class="vt-stat-value ${stats.malicious > 0 ? 'danger' : ''}">${stats.malicious}</span>
            <span>Malicious</span>
          </div>
          <div class="vt-stat">
            <span class="vt-stat-value ${stats.suspicious > 0 ? 'warning' : ''}">${stats.suspicious}</span>
            <span>Suspicious</span>
          </div>
          <div class="vt-stat">
            <span class="vt-stat-value success">${stats.harmless}</span>
            <span>Harmless</span>
          </div>
          <div class="vt-stat">
            <span class="vt-stat-value">${stats.undetected}</span>
            <span>Undetected</span>
          </div>
        </div>
      `;
    }

    function renderPdfResult(result) {
      const card = document.createElement('div');
      card.className = 'result-card';

      const overallStatus = result.vt_status || result.heuristic_status || result.status;
      const statusLabel = overallStatus === 'clean' ? 'Clean' : overallStatus === 'caution' ? 'Caution' : 'Warning';

      let vtSection = '';
      if (result.vt_stats) {
        vtSection = `
          <div style="margin-top: 8px;">
            <span class="vt-badge">VirusTotal Results</span>
            ${renderVtStats(result.vt_stats)}
            ${result.vt_permalink ? `<a href="${result.vt_permalink}" target="_blank" class="vt-link">View full report ‚Üí</a>` : ''}
          </div>
        `;
      }

      const findings = result.heuristic_findings || result.findings || [];
      let findingsHtml = '';
      if (findings.length > 0) {
        findingsHtml = `
          <ul class="finding-list">
            ${findings.map(f => `<li>${f.message} (${f.severity})</li>`).join('')}
          </ul>
        `;
      } else {
        findingsHtml = '<ul class="finding-list"><li>No risky patterns detected by heuristics.</li></ul>';
      }

      card.innerHTML = `
        <div class="result-header">
          <span class="file-name">${result.name}</span>
          <span class="status ${overallStatus}">${statusLabel}</span>
        </div>
        <div class="meta">
          <span class="pill">Size: ${result.size_human || humanSize(result.size_bytes)}</span>
          <span class="pill">Time: ${result.time_ms} ms</span>
          <span class="pill">PDF header: ${result.pdf_header_valid ? 'Valid' : 'Missing'}</span>
          ${result.sha256 ? `<span class="pill">SHA256: ${result.sha256.slice(0, 12)}...</span>` : ''}
        </div>
        <div><strong style="font-size: 13px;">Heuristic Analysis:</strong></div>
        ${findingsHtml}
        ${vtSection}
      `;
      results.prepend(card);
    }

    function renderUrlResult(result) {
      const card = document.createElement('div');
      card.className = 'result-card';

      const status = result.vt_status || 'clean';
      const statusLabel = status === 'clean' ? 'Safe' : status === 'caution' ? 'Suspicious' : 'Malicious';

      card.innerHTML = `
        <div class="result-header">
          <span class="file-name">${result.url}</span>
          <span class="status ${status}">${statusLabel}</span>
        </div>
        <div class="meta">
          <span class="pill">Time: ${result.time_ms} ms</span>
          ${result.categories ? `<span class="pill">Categories: ${Object.values(result.categories).slice(0, 3).join(', ')}</span>` : ''}
        </div>
        ${result.vt_stats ? `
          <div style="margin-top: 8px;">
            <span class="vt-badge">VirusTotal Results</span>
            ${renderVtStats(result.vt_stats)}
            ${result.vt_permalink ? `<a href="${result.vt_permalink}" target="_blank" class="vt-link">View full report ‚Üí</a>` : ''}
          </div>
        ` : '<p class="muted">Unable to get VirusTotal results. Check API configuration.</p>'}
      `;
      results.prepend(card);
    }

    async function analyzePdfFallback(file) {
      const started = performance.now();
      const buffer = await file.arrayBuffer();
      const text = new TextDecoder('latin1').decode(new Uint8Array(buffer));
      const findings = heuristics
        .filter(rule => rule.pattern.test(text))
        .map(rule => ({ message: rule.message, severity: rule.severity }));

      const hasHigh = findings.some(f => f.severity === 'high');
      const hasMedium = findings.some(f => f.severity === 'medium');

      let status = 'clean';
      if (hasHigh) status = 'warning';
      else if (hasMedium) status = 'caution';

      return {
        name: file.name || 'untitled.pdf',
        size_human: humanSize(file.size),
        size_bytes: file.size,
        findings,
        status,
        time_ms: Math.max(1, Math.round(performance.now() - started)),
        pdf_header_valid: text.startsWith('%PDF')
      };
    }

    async function scanViaApi(file, useVt = false) {
      const formData = new FormData();
      formData.append('file', file, file.name);

      const endpoint = useVt ? apiVtEndpoint : apiEndpoint;
      const response = await fetch(endpoint, { method: 'POST', body: formData });
      if (!response.ok) {
        const errText = await response.text();
        throw new Error(`API scan failed: ${response.status} ${errText}`);
      }
      return await response.json();
    }

    async function scanUrl(url) {
      const formData = new FormData();
      formData.append('url', url);

      const response = await fetch(apiUrlScanEndpoint, { method: 'POST', body: formData });
      if (!response.ok) {
        const errText = await response.text();
        throw new Error(`URL scan failed: ${response.status} ${errText}`);
      }
      return await response.json();
    }

    function showIdleCard() {
      results.innerHTML = `
        <div class="result-card">
          <div class="result-header">
            <span class="file-name">No scans yet</span>
            <span class="status caution">Idle</span>
          </div>
          <p class="muted">Drop a PDF or enter a URL above to see threat analysis results.</p>
        </div>
      `;
    }

    async function handleFiles(fileList) {
      try {
        const pdfs = Array.from(fileList).filter(file =>
          file.type === 'application/pdf' || (file.name && file.name.toLowerCase().endsWith('.pdf'))
        );

        if (!pdfs.length) {
          results.innerHTML = '<div class="result-card"><div class="result-header"><span class="file-name">Unsupported files</span><span class="status warning">Error</span></div><p class="muted">Please drop PDF files only.</p></div>';
          return;
        }

        results.innerHTML = '';

        for (const file of pdfs) {
          const scanningCard = document.createElement('div');
          scanningCard.className = 'result-card';
          scanningCard.innerHTML = `
            <div class="result-header">
              <span class="file-name">${file.name}</span>
              <span class="status caution"><span class="spinner"></span> Scanning‚Ä¶</span>
            </div>
            <p class="muted">${scanType === 'full' ? 'Running heuristics + VirusTotal analysis (may take 30+ seconds)‚Ä¶' : 'Running heuristic checks‚Ä¶'}</p>
          `;
          results.prepend(scanningCard);

          try {
            let result;
            if (apiAvailable) {
              try {
                result = await scanViaApi(file, scanType === 'full');
              } catch (apiError) {
                console.warn('API scan failed, falling back to local scan', apiError);
                result = await analyzePdfFallback(file);
                result.name += ' (local fallback)';
              }
            } else {
              result = await analyzePdfFallback(file);
              result.name += ' (local fallback)';
            }
            if (scanningCard.parentNode) scanningCard.remove();
            renderPdfResult(result);
          } catch (err) {
            if (scanningCard.parentNode) scanningCard.remove();
            const errorCard = document.createElement('div');
            errorCard.className = 'result-card';
            errorCard.innerHTML = `
              <div class="result-header">
                <span class="file-name">${file.name}</span>
                <span class="status warning">Failed</span>
              </div>
              <p class="muted">Could not read this file. It may be encrypted or corrupted.</p>
            `;
            results.prepend(errorCard);
            console.error(err);
          }
        }
        fileInput.value = '';
      } catch (globalErr) {
        console.error("Critical error in handleFiles:", globalErr);
        results.innerHTML = `<div class="result-card"><div class="result-header"><span class="file-name">System Error</span><span class="status warning">Crash</span></div><p class="muted">An unexpected error occurred: ${globalErr.message}</p></div>`;
      }
    }

    async function handleUrlScan() {
      const url = urlInput.value.trim();
      if (!url) {
        alert('Please enter a URL to scan.');
        return;
      }

      if (!url.startsWith('http://') && !url.startsWith('https://')) {
        alert('URL must start with http:// or https://');
        return;
      }

      const scanningCard = document.createElement('div');
      scanningCard.className = 'result-card';
      scanningCard.innerHTML = `
        <div class="result-header">
          <span class="file-name">${url}</span>
          <span class="status caution"><span class="spinner"></span> Scanning URL‚Ä¶</span>
        </div>
        <p class="muted">Checking against VirusTotal's 70+ security vendors (may take 30+ seconds)‚Ä¶</p>
      `;

      // Clear idle card if present
      if (results.querySelector('.file-name')?.textContent === 'No scans yet') {
        results.innerHTML = '';
      }
      results.prepend(scanningCard);

      try {
        const result = await scanUrl(url);
        if (scanningCard.parentNode) scanningCard.remove();
        renderUrlResult(result);
        urlInput.value = '';
      } catch (err) {
        if (scanningCard.parentNode) scanningCard.remove();
        const errorCard = document.createElement('div');
        errorCard.className = 'result-card';
        errorCard.innerHTML = `
          <div class="result-header">
            <span class="file-name">${url}</span>
            <span class="status warning">Failed</span>
          </div>
          <p class="muted">${err.message || 'Could not scan this URL. Check API configuration.'}</p>
        `;
        results.prepend(errorCard);
        console.error(err);
      }
    }

    // Tab switching
    tabBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        tabBtns.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.getElementById(`tab-${btn.dataset.tab}`).classList.add('active');
      });
    });

    // Scan type toggle
    scanTypeBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        scanTypeBtns.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        scanType = btn.dataset.type;
      });
    });

    // Prevent browser from opening files when dropped outside the dropzone.
    ['dragover', 'drop'].forEach(evt =>
      window.addEventListener(evt, e => e.preventDefault(), false)
    );

    dropzone.addEventListener('dragover', event => {
      event.preventDefault();
      dropzone.classList.add('dragover');
    });

    dropzone.addEventListener('dragleave', () => {
      dropzone.classList.remove('dragover');
    });

    dropzone.addEventListener('drop', event => {
      event.preventDefault();
      dropzone.classList.remove('dragover');
      const files = event.dataTransfer && event.dataTransfer.files;
      if (files && files.length) {
        handleFiles(files);
      }
    });

    dropzone.addEventListener('click', event => {
      if (event.target === fileInput || event.target.closest('label[for="fileInput"]')) return;
      if (event.target && typeof event.target.closest === 'function' && event.target.closest('#demoBtn')) return;
      if (event.target && typeof event.target.closest === 'function' && event.target.closest('.scan-type-btn')) return;
      
      if (typeof fileInput.showPicker === 'function') {
        fileInput.showPicker();
      } else {
        fileInput.click();
      }
    });

    fileInput.addEventListener('change', e => handleFiles(e.target.files));

    demoBtn.addEventListener('click', () => {
      const mock = new File([`%PDF-1.7\n/JavaScript /Launch /OpenAction`], 'demo-suspicious.pdf', { type: 'application/pdf' });
      handleFiles([mock]);
    });

    modeToggle.addEventListener('click', () => {
      const current = document.body.getAttribute('data-theme');
      setTheme(current === 'dark' ? 'light' : 'dark');
    });

    urlScanBtn.addEventListener('click', handleUrlScan);
    urlInput.addEventListener('keydown', e => {
      if (e.key === 'Enter') handleUrlScan();
    });

    async function checkApi() {
      try {
        const controller = new AbortController();
        const timer = setTimeout(() => controller.abort(), 1200);
        const res = await fetch(healthEndpoint, { signal: controller.signal });
        clearTimeout(timer);
        if (res.ok) {
          const data = await res.json();
          apiAvailable = true;
          vtConfigured = data.vt_configured;
          vtStatus.textContent = vtConfigured ? '‚úì VT Ready' : '‚ö† VT Not Configured';
          vtStatus.style.background = vtConfigured ? 'rgba(52, 211, 153, 0.15)' : 'rgba(251, 191, 36, 0.15)';
          vtStatus.style.color = vtConfigured ? 'var(--success)' : 'var(--warning)';
        } else {
          apiAvailable = false;
          vtStatus.textContent = '‚úó API Offline';
          vtStatus.style.background = 'rgba(244, 114, 182, 0.15)';
          vtStatus.style.color = 'var(--danger)';
        }
      } catch (err) {
        apiAvailable = false;
        vtStatus.textContent = '‚úó API Offline';
        vtStatus.style.background = 'rgba(244, 114, 182, 0.15)';
        vtStatus.style.color = 'var(--danger)';
      }
    }

    initTheme();
    showIdleCard();
    checkApi();
  </script>
</body>
</html>
